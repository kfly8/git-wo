#!/bin/bash
#
# git wo - git worktree wrapper with ghq-style paths
#
# Usage:
#   git wo init
#   git wo [-C <path>] add <name> [base-branch] [git worktree add options...]
#   git wo [-C <path>] list
#   git wo [-C <path>] remove <path>
#   git wo [-C <path>] prune
#   git wo [-C <path>] prune-merged [main-branch]
#
# Examples:
#   git wo add feature1              # create from current branch
#   git wo add feature1 main         # create from main
#   git wo add feature1 main --track # pass options to git worktree add
#   git wo -C /path/to/repo add feature1  # specify main directory

set -e

# Configuration via git-config
# - wo.root: Base directory for worktrees (default: ~/worktree)
# - wo.postHook: Script to run after creating a worktree
# - wo.mainDir: Main worktree directory (default: current directory)

# Parse -C option for specifying main directory
MAIN_DIR=""
while [[ "$1" == "-C" ]]; do
  shift
  MAIN_DIR="$1"
  shift
done

# Change to main directory if specified
if [[ -n "$MAIN_DIR" ]]; then
  if [[ ! -d "$MAIN_DIR" ]]; then
    echo "Error: Directory not found: $MAIN_DIR" >&2
    exit 1
  fi
  cd "$MAIN_DIR"
fi

get_config() {
  git config --get "$1" 2>/dev/null || echo "$2"
}

# If no -C option, check wo.mainDir config
if [[ -z "$MAIN_DIR" ]]; then
  config_main_dir="$(get_config wo.mainDir "")"
  if [[ -n "$config_main_dir" ]]; then
    config_main_dir="${config_main_dir/#\~/$HOME}"
    if [[ -d "$config_main_dir" ]]; then
      cd "$config_main_dir"
    fi
  fi
fi

WORKTREE_ROOT="$(get_config wo.root "$HOME/worktree")"
WORKTREE_ROOT="${WORKTREE_ROOT/#\~/$HOME}"

# Extract host/user/repo from remote URL
get_repo_path() {
  local remote_url=$(git remote get-url origin 2>/dev/null)
  if [[ -z "$remote_url" ]]; then
    echo "Error: No origin remote found" >&2
    return 1
  fi

  local repo_path
  # git@host:user/repo.git
  if [[ "$remote_url" =~ ^git@([^:]+):(.+)$ ]]; then
    repo_path="${BASH_REMATCH[1]}/${BASH_REMATCH[2]%.git}"
  # https://host/user/repo.git
  elif [[ "$remote_url" =~ ^https?://([^/]+)/(.+)$ ]]; then
    repo_path="${BASH_REMATCH[1]}/${BASH_REMATCH[2]%.git}"
  else
    repo_path=$(basename "$(git rev-parse --show-toplevel)")
  fi

  echo "$repo_path"
}

branch_exists() {
  git show-ref --verify --quiet "refs/heads/$1"
}

cmd_add() {
  if [[ -z "$1" ]]; then
    echo "Usage: git wo add <name> [base-branch] [options...]"
    echo ""
    echo "If the branch already exists, it will be used without creating a new one."
    echo ""
    echo "Examples:"
    echo "  git wo add feature1          # from current branch"
    echo "  git wo add feature1 main     # from main"
    exit 1
  fi

  local name="$1"
  shift

  local repo_path=$(get_repo_path) || exit 1
  local worktree_dir="${WORKTREE_ROOT}/${repo_path}/${name}"

  # Parse base branch (first non-option argument)
  local base_branch=""
  local extra_args=()

  if [[ -n "$1" && ! "$1" =~ ^- ]]; then
    base_branch="$1"
    shift
  fi
  extra_args=("$@")

  mkdir -p "$(dirname "$worktree_dir")"

  if branch_exists "$name"; then
    # 既存ブランチを使用
    if [[ -n "$base_branch" ]]; then
      echo "Note: Ignoring base branch '$base_branch' because branch '$name' already exists"
    fi
    git worktree add "$worktree_dir" "$name" "${extra_args[@]}"
    echo ""
    echo "Created: $worktree_dir"
    echo "Using existing branch: $name"
  else
    # 新規ブランチを作成
    if [[ -n "$base_branch" ]]; then
      git worktree add -b "$name" "$worktree_dir" "$base_branch" "${extra_args[@]}"
    else
      git worktree add -b "$name" "$worktree_dir" "${extra_args[@]}"
    fi
    echo ""
    echo "Created: $worktree_dir"
    echo "Created new branch: $name"
  fi

  # Run post hook if configured
  local post_hook="$(get_config wo.postHook "")"
  if [[ -n "$post_hook" ]]; then
    post_hook="${post_hook/#\~/$HOME}"
    if [[ -x "$post_hook" ]]; then
      echo "Running post hook..."
      ORIGINAL_PATH="$(git rev-parse --show-toplevel)" \
      WORKTREE_PATH="$worktree_dir" \
      BRANCH_NAME="$name" \
      "$post_hook"
    elif [[ -f "$post_hook" ]]; then
      echo "Warning: post hook is not executable: $post_hook" >&2
    fi
  fi
}

cmd_remove() {
  if [[ -z "$1" ]]; then
    echo "Usage: git wo remove <path> [options...]"
    exit 1
  fi

  local path="$1"
  shift
  local extra_args=("$@")

  # Get branch name from worktree path
  local branch=$(git worktree list | grep "^$path " | sed 's/.*\[\(.*\)\].*/\1/')

  # Remove worktree
  git worktree remove "$path" "${extra_args[@]}"

  # Delete branch if found
  if [[ -n "$branch" && "$branch" != "detached" ]]; then
    echo "Deleting branch: $branch"
    git branch -d "$branch"
  fi
}

cmd_init() {
  local script_dir
  script_dir="$(cd "$(dirname "$0")" && pwd)"

  local sandbox_profile
  sandbox_profile="$(get_config wo.sandboxProfile "")"
  if [[ -z "$sandbox_profile" ]]; then
    sandbox_profile="${script_dir}/sandbox/git-wo.sb"
  else
    sandbox_profile="${sandbox_profile/#\~/$HOME}"
  fi

  cat <<SHELL_INTEGRATION
# git-wo shell integration
# Add to your shell config: eval "\$(git-wo init)"

_git_wo_chpwd() {
  local worktree_root="${WORKTREE_ROOT}"

  # Skip if already inside sandbox or sandbox is disabled
  [[ -n "\$GIT_WO_SANDBOX" ]] && return
  [[ -n "\$GIT_WO_NO_SANDBOX" ]] && return

  # Skip if not under worktree root
  [[ "\$PWD" != "\$worktree_root"/* ]] && return

  # Skip if sandbox-exec is not available (non-macOS)
  command -v sandbox-exec >/dev/null 2>&1 || return

  local sandbox_profile="${sandbox_profile}"
  if [[ ! -f "\$sandbox_profile" ]]; then
    echo "git-wo: sandbox profile not found: \$sandbox_profile" >&2
    return
  fi

  local repo_path
  repo_path="\$(git rev-parse --git-common-dir 2>/dev/null)" || return
  repo_path="\$(cd "\$repo_path" 2>/dev/null && pwd)" || return

  echo "Entering sandbox for: \$PWD"
  GIT_WO_SANDBOX=1 sandbox-exec -f "\$sandbox_profile" \\
    -D HOME="\$HOME" \\
    -D WORKTREE_PATH="\$PWD" \\
    -D REPO_PATH="\$repo_path" \\
    "\$SHELL"
  echo "Left sandbox"
}

if [[ -n "\$ZSH_VERSION" ]]; then
  autoload -Uz add-zsh-hook
  add-zsh-hook chpwd _git_wo_chpwd
fi

if [[ -n "\$BASH_VERSION" ]]; then
  cd() {
    builtin cd "\$@" || return
    _git_wo_chpwd
  }
fi
SHELL_INTEGRATION
}

cmd_prune_merged() {
  local main_branch="${1:-main}"
  # Filter out: * (current branch), main, master, devel
  # Keep + (worktree branches) as they should be pruned too
  local merged=$(git branch --merged "$main_branch" | grep -v -E '^\*|^\s*(main|master|devel)\s*$' | sed 's/^[+[:space:]]*//')

  if [[ -z "$merged" ]]; then
    echo "No merged branches found"
    return 0
  fi

  echo "Merged branches:"
  echo "$merged"
  echo ""

  # First, remove worktrees
  while IFS= read -r branch; do
    local path=$(git worktree list | grep "\[$branch\]" | awk '{print $1}')
    if [[ -n "$path" ]]; then
      echo "Removing worktree: $path ($branch)"
      git worktree remove "$path"
    fi
  done <<< "$merged"

  git worktree prune

  # Then, delete branches one by one
  echo ""
  echo "Deleting merged branches..."
  while IFS= read -r branch; do
    git branch -d "$branch" 2>/dev/null && echo "Deleted branch $branch" || echo "Failed to delete $branch"
  done <<< "$merged"
}

# Main
case "${1:-}" in
  init)
    shift
    cmd_init "$@"
    ;;
  add)
    shift
    cmd_add "$@"
    ;;
  list|ls)
    shift
    git worktree list "$@"
    ;;
  remove|rm)
    shift
    cmd_remove "$@"
    ;;
  prune)
    shift
    git worktree prune "$@"
    ;;
  prune-merged)
    shift
    cmd_prune_merged "$@"
    ;;
  *)
    # Pass through to git worktree for other commands
    if [[ -n "$1" ]]; then
      git worktree "$@"
    else
      echo "Usage: git wo [-C <path>] <command> [options]"
      echo ""
      echo "Options:"
      echo "  -C <path>                 Run as if started in <path>"
      echo ""
      echo "Commands:"
      echo "  init                      Output shell integration for sandbox"
      echo "  add <name> [base] [opts]  Create worktree at $WORKTREE_ROOT/<repo>/<name>"
      echo "  list                      List worktrees"
      echo "  remove <path>             Remove worktree and its branch"
      echo "  prune                     Prune stale worktree info"
      echo "  prune-merged [branch]     Remove worktrees for merged branches"
      echo ""
      echo "Configuration (git config):"
      echo "  wo.root           = $WORKTREE_ROOT"
      echo "  wo.mainDir        = $(get_config wo.mainDir '(not set)')"
      echo "  wo.postHook       = $(get_config wo.postHook '(not set)')"
      echo "  wo.sandboxProfile = $(get_config wo.sandboxProfile '(not set)')"
    fi
    ;;
esac
