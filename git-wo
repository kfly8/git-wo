#!/bin/bash
#
# git wo - git worktree wrapper with ghq-style paths
#
# Usage:
#   git wo add <name> [base-branch] [git worktree add options...]
#   git wo list
#   git wo remove <path>
#   git wo prune
#   git wo prune-merged [main-branch]
#
# Examples:
#   git wo add feature1              # create from current branch
#   git wo add feature1 main         # create from main
#   git wo add feature1 main --track # pass options to git worktree add

set -e

# Configuration via git-config
# - wo.root: Base directory for worktrees (default: ~/worktree)
# - wo.postHook: Script to run after creating a worktree

get_config() {
  git config --get "$1" 2>/dev/null || echo "$2"
}

WORKTREE_ROOT="$(get_config wo.root "$HOME/worktree")"

# Extract host/user/repo from remote URL
get_repo_path() {
  local remote_url=$(git remote get-url origin 2>/dev/null)
  if [[ -z "$remote_url" ]]; then
    echo "Error: No origin remote found" >&2
    return 1
  fi

  local repo_path
  # git@host:user/repo.git
  if [[ "$remote_url" =~ ^git@([^:]+):(.+?)(\.git)?$ ]]; then
    repo_path="${BASH_REMATCH[1]}/${BASH_REMATCH[2]%.git}"
  # https://host/user/repo.git
  elif [[ "$remote_url" =~ ^https?://([^/]+)/(.+?)(\.git)?$ ]]; then
    repo_path="${BASH_REMATCH[1]}/${BASH_REMATCH[2]%.git}"
  else
    repo_path=$(basename "$(git rev-parse --show-toplevel)")
  fi

  echo "$repo_path"
}

cmd_add() {
  if [[ -z "$1" ]]; then
    echo "Usage: git wo add <name> [base-branch] [options...]"
    echo ""
    echo "Examples:"
    echo "  git wo add feature1          # from current branch"
    echo "  git wo add feature1 main     # from main"
    exit 1
  fi

  local name="$1"
  shift

  local repo_path=$(get_repo_path) || exit 1
  local worktree_dir="${WORKTREE_ROOT}/${repo_path}/${name}"

  # Parse base branch (first non-option argument)
  local base_branch=""
  local extra_args=()

  if [[ -n "$1" && ! "$1" =~ ^- ]]; then
    base_branch="$1"
    shift
  fi
  extra_args=("$@")

  mkdir -p "$(dirname "$worktree_dir")"

  if [[ -n "$base_branch" ]]; then
    git worktree add -b "$name" "$worktree_dir" "$base_branch" "${extra_args[@]}"
  else
    git worktree add -b "$name" "$worktree_dir" "${extra_args[@]}"
  fi

  echo ""
  echo "Created: $worktree_dir"

  # Run post hook if configured
  local post_hook="$(get_config wo.postHook "")"
  if [[ -n "$post_hook" ]]; then
    post_hook="${post_hook/#\~/$HOME}"
    if [[ -x "$post_hook" ]]; then
      echo "Running post hook..."
      ORIGINAL_PATH="$(git rev-parse --show-toplevel)" \
      WORKTREE_PATH="$worktree_dir" \
      BRANCH_NAME="$name" \
      "$post_hook"
    elif [[ -f "$post_hook" ]]; then
      echo "Warning: post hook is not executable: $post_hook" >&2
    fi
  fi
}

cmd_remove() {
  if [[ -z "$1" ]]; then
    echo "Usage: git wo remove <path> [options...]"
    exit 1
  fi

  local path="$1"
  shift
  local extra_args=("$@")

  # Get branch name from worktree path
  local branch=$(git worktree list | grep "^$path " | sed 's/.*\[\(.*\)\].*/\1/')

  # Remove worktree
  git worktree remove "$path" "${extra_args[@]}"

  # Delete branch if found
  if [[ -n "$branch" && "$branch" != "detached" ]]; then
    echo "Deleting branch: $branch"
    git branch -d "$branch"
  fi
}

cmd_prune_merged() {
  local main_branch="${1:-main}"
  # Filter out: * (current branch), main, master, devel
  # Keep + (worktree branches) as they should be pruned too
  local merged=$(git branch --merged "$main_branch" | grep -v -E '^\*|^\s*(main|master|devel)\s*$' | sed 's/^[+[:space:]]*//')

  if [[ -z "$merged" ]]; then
    echo "No merged branches found"
    return 0
  fi

  echo "Merged branches:"
  echo "$merged"
  echo ""

  # First, remove worktrees
  while IFS= read -r branch; do
    local path=$(git worktree list | grep "\[$branch\]" | awk '{print $1}')
    if [[ -n "$path" ]]; then
      echo "Removing worktree: $path ($branch)"
      git worktree remove "$path"
    fi
  done <<< "$merged"

  git worktree prune

  # Then, delete branches one by one
  echo ""
  echo "Deleting merged branches..."
  while IFS= read -r branch; do
    git branch -d "$branch" 2>/dev/null && echo "Deleted branch $branch" || echo "Failed to delete $branch"
  done <<< "$merged"
}

# Main
case "${1:-}" in
  add)
    shift
    cmd_add "$@"
    ;;
  list|ls)
    shift
    git worktree list "$@"
    ;;
  remove|rm)
    shift
    cmd_remove "$@"
    ;;
  prune)
    shift
    git worktree prune "$@"
    ;;
  prune-merged)
    shift
    cmd_prune_merged "$@"
    ;;
  *)
    # Pass through to git worktree for other commands
    if [[ -n "$1" ]]; then
      git worktree "$@"
    else
      echo "Usage: git wo <command> [options]"
      echo ""
      echo "Commands:"
      echo "  add <name> [base] [opts]  Create worktree at $WORKTREE_ROOT/<repo>/<name>"
      echo "  list                      List worktrees"
      echo "  remove <path>             Remove worktree and its branch"
      echo "  prune                     Prune stale worktree info"
      echo "  prune-merged [branch]     Remove worktrees for merged branches"
      echo ""
      echo "Configuration (git config):"
      echo "  wo.root      = $WORKTREE_ROOT"
      echo "  wo.postHook  = $(get_config wo.postHook '(not set)')"
    fi
    ;;
esac
